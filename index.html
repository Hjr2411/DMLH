<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerenciador DML — Validação Admin</title>
<style>
body { font-family: Arial; margin: 20px; }
input, textarea { width: 100%; margin: 5px 0; }
button { margin: 3px; }
.executado { color: gray; }
</style>
</head>
<body>

<h2>Gerenciador de Comandos DML</h2>

<textarea id="comandoInput" placeholder="Comandos DML"></textarea>
<input type="text" id="nChamadoInput" placeholder="Número do Chamado">
<input type="text" id="usuarioInput" placeholder="Usuário">
<input type="text" id="motivoInput" placeholder="Motivo">
<button onclick="salvarComandos()">Salvar</button>
<button onclick="copiarPendentes()">Copiar Pendentes</button>
<button onclick="marcarTodosPendentes()">Marcar Todos</button>

<div>
<h4>Comandos</h4>
<table border="1" width="100%">
<thead><tr><th>ID</th><th>Comando</th><th>✔</th><th>❌</th><th>Chamado</th><th>Usuário</th><th>Data</th></tr></thead>
<tbody id="tabelaComandos"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, set, update, remove, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  databaseURL: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let usuarioLogado = null;
let tipoUsuario = 'user';

async function login() {
  usuarioLogado = prompt("Digite seu login:").trim();
  const usuarioRef = ref(db, `usuarios/${usuarioLogado}`);
  const snap = await get(usuarioRef);
  if (snap.exists()) {
    tipoUsuario = snap.val();
    alert(`Bem-vindo, ${usuarioLogado} (${tipoUsuario})`);
    carregarComandos();
  } else {
    alert("Usuário não encontrado.");
  }
}

async function getNextId() {
  const idRef = ref(db, 'contadores/ultimoId');
  const result = await runTransaction(idRef, c => (c || 0) + 1);
  return String(result.snapshot.val()).padStart(5, '0');
}

async function salvarComandos() {
  const comandosTexto = document.getElementById('comandoInput').value.trim();
  const nChamado = document.getElementById('nChamadoInput').value.trim();
  const usuario = document.getElementById('usuarioInput').value.trim();
  const motivo = document.getElementById('motivoInput').value.trim();
  const dataHora = new Date().toLocaleString('pt-BR');
  if (!comandosTexto || !nChamado || !usuario || !motivo) {
    alert("Preencha todos os campos!"); return;
  }
  const comandos = comandosTexto.split('\n').map(c => c.trim()).filter(c => c);
  for (const comando of comandos) {
    const novoId = await getNextId();
    await set(ref(db, `comandos/${novoId}`), {
      id: novoId, comando, nChamado, usuario, motivo, dataHora, executado: false
    });
  }
  carregarComandos();
}

function carregarComandos() {
  const comandosRef = ref(db, 'comandos');
  onValue(comandosRef, snap => {
    const tbody = document.getElementById('tabelaComandos');
    tbody.innerHTML = '';
    snap.forEach(child => {
      const item = child.val();
      const tr = document.createElement('tr');
      if (item.executado) tr.classList.add('executado');
      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${item.comando}</td>
        <td><input type="checkbox" ${item.executado ? 'checked' : ''} ${tipoUsuario==='admin'?'':'disabled'} onchange="atualizarStatus('${item.id}', this.checked)"></td>
        <td>${tipoUsuario==='admin' ? `<button onclick="excluirComando('${item.id}')">X</button>` : ''}</td>
        <td>${item.nChamado}</td>
        <td>${item.usuario}</td>
        <td>${item.dataHora}</td>
      `;
      tbody.appendChild(tr);
    });
  });
}

window.atualizarStatus = function(id, status) {
  if (tipoUsuario !== 'admin') return;
  const refComando = ref(db, `comandos/${id}`);
  update(refComando, { executado: status });
}

window.excluirComando = function(id) {
  if (tipoUsuario !== 'admin') return;
  if (confirm("Excluir?")) {
    remove(ref(db, `comandos/${id}`));
  }
}

window.marcarTodosPendentes = function() {
  if (tipoUsuario !== 'admin') return;
  document.querySelectorAll('#tabelaComandos tr').forEach(tr => {
    const id = tr.children[0].innerText;
    const cb = tr.querySelector('input[type=checkbox]');
    if (cb && !cb.checked) {
      atualizarStatus(id, true);
    }
  });
}

window.copiarPendentes = function() {
  let txt = '';
  document.querySelectorAll('#tabelaComandos tr').forEach(tr => {
    const cb = tr.querySelector('input[type=checkbox]');
    if (cb && !cb.checked) txt += tr.children[1].innerText+'\n';
  });
  navigator.clipboard.writeText(txt.trim());
  alert("Pendentes copiados");
}

login();
</script>

</body>
</html>